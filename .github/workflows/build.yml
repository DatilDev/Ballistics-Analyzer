name: Build and Release

on:
  push:
    branches: [ main ]
    tags: [ 'v*' ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

env:
  CARGO_TERM_COLOR: always
  RUST_BACKTRACE: 1
  RUSQLITE_BUNDLED: 1
  LIBSQLITE3_SYS_BUNDLING: 1

jobs:
  # PWA Build
  build-web:
    name: Build PWA
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4
    
    - name: Setup Rust
      uses: dtolnay/rust-toolchain@stable
      with:
        targets: wasm32-unknown-unknown
        
    - name: Install wasm-pack
      run: curl https://rustwasm.github.io/wasm-pack/installer/init.sh -sSf | sh
      
    - name: Build WASM
      run: |
        wasm-pack build --target web --out-dir pkg --release \
          --no-default-features --features web
        
    - name: Prepare dist
      run: |
        mkdir -p dist
        cp -r pkg dist/ || true
        cp index.html dist/ || echo "No index.html"
        cp manifest.json dist/ || echo "No manifest.json"
        
    - name: Upload artifacts
      uses: actions/upload-artifact@v4
      with:
        name: pwa-build
        path: dist/

  # Desktop Builds
  build-desktop:
    name: Build ${{ matrix.name }}
    strategy:
      fail-fast: false
      matrix:
        include:
          - os: ubuntu-latest
            name: Linux
            target: x86_64-unknown-linux-gnu
            
          - os: windows-latest
            name: Windows
            target: x86_64-pc-windows-msvc
            
          - os: macos-latest
            name: macOS-x64
            target: x86_64-apple-darwin
            
          - os: macos-latest
            name: macOS-arm64
            target: aarch64-apple-darwin
            
    runs-on: ${{ matrix.os }}
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Setup Rust
      uses: dtolnay/rust-toolchain@stable
      with:
        targets: ${{ matrix.target }}
        
    - name: Install Linux dependencies
      if: runner.os == 'Linux'
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          libgtk-3-dev \
          libssl-dev \
          pkg-config \
          libxcb-render0-dev \
          libxcb-shape0-dev \
          libxcb-xfixes0-dev \
          libxkbcommon-dev \
          libglu1-mesa-dev
        
    - name: Build
      run: cargo build --release --target ${{ matrix.target }}
      env:
        RUSQLITE_BUNDLED: 1
        LIBSQLITE3_SYS_BUNDLING: 1
        
    - name: Upload artifacts
      uses: actions/upload-artifact@v4
      with:
        name: ${{ matrix.name }}-build
        path: |
          target/${{ matrix.target }}/release/ballistics-analyzer*
          !target/**/*.d
          !target/**/*.rlib

  # Arch Linux Build
  build-arch:
    name: Build Arch Linux
    runs-on: ubuntu-latest
    container: archlinux:latest
    
    steps:
    - name: Setup environment
      run: |
        pacman -Syu --noconfirm
        pacman -S --noconfirm base-devel rust cargo git gtk3 pkgconf
        
    - uses: actions/checkout@v4
      
    - name: Build
      run: |
        export RUSQLITE_BUNDLED=1
        export LIBSQLITE3_SYS_BUNDLING=1
        cargo build --release
        
    - name: Package
      run: |
        mkdir -p pkg/usr/bin
        cp target/release/ballistics-analyzer pkg/usr/bin/
        tar czf ballistics-analyzer-arch.tar.gz -C pkg .
        
    - name: Upload
      uses: actions/upload-artifact@v4
      with:
        name: arch-build
        path: ballistics-analyzer-arch.tar.gz

  # Android Build
  build-android:
    name: Build Android
    runs-on: ubuntu-latest
    continue-on-error: true
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Setup Rust
      uses: dtolnay/rust-toolchain@stable
      with:
        targets: aarch64-linux-android
        
    - name: Setup Android NDK
      uses: nttld/setup-ndk@v1
      with:
        ndk-version: r25c
        
    - name: Install cargo-ndk
      run: cargo install cargo-ndk
        
    - name: Build
      run: |
        cargo ndk -t arm64-v8a build --release \
          --no-default-features --features android
      env:
        RUSQLITE_BUNDLED: 1
        
    - name: Upload
      uses: actions/upload-artifact@v4
      with:
        name: android-build
        path: target/aarch64-linux-android/release/*.so
        if-no-files-found: warn